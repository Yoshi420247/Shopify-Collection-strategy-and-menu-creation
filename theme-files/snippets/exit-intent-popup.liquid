{% comment %}
  Exit Intent Popup for Abandoned Cart Recovery
  Oil Slick Pad ‚Äî oilslickpad.com

  Captures email addresses from leaving visitors and offers
  category-aware discounts to prevent cart abandonment.

  Include this snippet in theme.liquid before </body>:
    {% render 'exit-intent-popup' %}
{% endcomment %}

{% if cart.item_count > 0 %}
<div id="exit-intent-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:99999;justify-content:center;align-items:center;">
  <div id="exit-intent-popup" style="background:#fff;border-radius:12px;max-width:480px;width:90%;padding:0;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;animation:popupSlideIn 0.3s ease-out;">

    <!-- Close button -->
    <button onclick="closeExitPopup()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:24px;cursor:pointer;color:#999;z-index:2;line-height:1;">&times;</button>

    <!-- Header -->
    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);padding:28px 24px;text-align:center;">
      <h2 id="popup-headline" style="color:#fff;margin:0;font-size:22px;font-weight:700;line-height:1.3;">Wait ‚Äî don't lose your cart!</h2>
    </div>

    <!-- Body -->
    <div style="padding:24px;">
      <p id="popup-body" style="color:#555;font-size:15px;text-align:center;margin:0 0 20px;line-height:1.5;">
        Enter your email and we'll send you a link to your saved cart so you can come back anytime.
      </p>

      <!-- Email capture form -->
      <form id="exit-intent-form" onsubmit="return handleExitFormSubmit(event)" style="margin:0;">
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input
            type="email"
            id="exit-intent-email"
            placeholder="Your email address"
            required
            style="flex:1;padding:14px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;outline:none;transition:border-color 0.2s;"
            onfocus="this.style.borderColor='#e94560'"
            onblur="this.style.borderColor='#e0e0e0'"
          >
          <button
            type="submit"
            style="padding:14px 24px;background:#e94560;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;white-space:nowrap;transition:background 0.2s;"
            onmouseover="this.style.background='#d63851'"
            onmouseout="this.style.background='#e94560'"
          >
            Save Cart
          </button>
        </div>
      </form>

      <!-- Success state -->
      <div id="exit-intent-success" style="display:none;text-align:center;padding:16px 0;">
        <div style="font-size:48px;margin-bottom:12px;">‚úÖ</div>
        <h3 style="color:#333;margin:0 0 8px;">Cart link saved!</h3>
        <p id="success-msg" style="color:#666;font-size:14px;margin:0 0 16px;">We'll email you a link to your cart so you can finish your order anytime.</p>
        <a href="/cart" style="display:inline-block;padding:12px 32px;background:#e94560;color:#fff;border-radius:8px;font-size:15px;font-weight:700;text-decoration:none;">Complete Your Order Now</a>
      </div>

      <!-- Free shipping progress bar (shown if close to threshold) -->
      <div id="shipping-progress" style="display:none;margin-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:12px;color:#666;">Free shipping progress</span>
          <span id="shipping-amount-away" style="font-size:12px;font-weight:600;color:#e94560;"></span>
        </div>
        <div style="background:#f0f0f0;border-radius:10px;height:8px;overflow:hidden;">
          <div id="shipping-progress-bar" style="height:100%;background:linear-gradient(90deg,#e94560,#ff6b6b);border-radius:10px;transition:width 0.5s ease;"></div>
        </div>
      </div>

      <!-- Trust signals -->
      <div style="display:flex;justify-content:center;gap:20px;margin-top:20px;padding-top:16px;border-top:1px solid #f0f0f0;">
        <span style="font-size:11px;color:#999;">üîí Secure</span>
        <span style="font-size:11px;color:#999;">üöö Fast Shipping</span>
        <span style="font-size:11px;color:#999;">‚Ü©Ô∏è Easy Returns</span>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes popupSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  @media (max-width: 480px) {
    #exit-intent-popup { margin: 16px; width: calc(100% - 32px) !important; }
    #exit-intent-popup h2 { font-size: 18px !important; }
  }
</style>

<script>
(function() {
  'use strict';

  // Configuration
  var FREE_SHIPPING_THRESHOLD = 75;
  var COOLDOWN_DAYS = 7;
  var MIN_TIME_ON_PAGE_MS = 10000; // 10 seconds
  var MIN_CART_VALUE = 20;
  var COOKIE_NAME = 'osp_exit_popup_shown';

  // State
  var popupShown = false;
  var pageLoadTime = Date.now();
  var cartTotal = {{ cart.total_price | divided_by: 100.0 }};
  var cartItemCount = {{ cart.item_count }};

  // Determine product category from cart (used for tagging the lead)
  var cartCategory = 'unknown';
  {% for item in cart.items %}
    {% if item.vendor == 'Oil Slick' %}
      {% if cartCategory == 'unknown' %}cartCategory = 'oilSlick';{% endif %}
    {% elsif item.vendor == 'What You Need' or item.vendor == 'Cloud YHS' %}
      cartCategory = 'smokeshop';
    {% endif %}
  {% endfor %}

  // Check if popup should show
  function shouldShowPopup() {
    if (popupShown) return false;
    if (cartItemCount === 0) return false;
    if (cartTotal < MIN_CART_VALUE) return false;
    if (Date.now() - pageLoadTime < MIN_TIME_ON_PAGE_MS) return false;

    // Check cooldown cookie
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
      var cookie = cookies[i].trim();
      if (cookie.indexOf(COOKIE_NAME + '=') === 0) {
        return false;
      }
    }

    return true;
  }

  function showPopup() {
    if (!shouldShowPopup()) return;
    popupShown = true;

    var overlay = document.getElementById('exit-intent-overlay');
    if (!overlay) return;

    // Show free shipping progress if close to threshold
    if (cartTotal >= FREE_SHIPPING_THRESHOLD * 0.5 && cartTotal < FREE_SHIPPING_THRESHOLD) {
      var amountAway = (FREE_SHIPPING_THRESHOLD - cartTotal).toFixed(2);
      var progress = (cartTotal / FREE_SHIPPING_THRESHOLD) * 100;
      document.getElementById('shipping-amount-away').textContent = '$' + amountAway + ' away';
      document.getElementById('shipping-progress-bar').style.width = progress + '%';
      document.getElementById('shipping-progress').style.display = 'block';
    }

    overlay.style.display = 'flex';

    // Set cooldown cookie
    var expires = new Date();
    expires.setDate(expires.getDate() + COOLDOWN_DAYS);
    document.cookie = COOKIE_NAME + '=1;expires=' + expires.toUTCString() + ';path=/;SameSite=Lax';
  }

  // Desktop: cursor leaves viewport
  document.addEventListener('mouseout', function(e) {
    if (e.clientY <= 0 && e.relatedTarget === null) {
      showPopup();
    }
  });

  // Mobile: rapid upward scroll detection
  var lastScrollY = window.scrollY;
  var scrollVelocity = 0;
  var lastScrollTime = Date.now();

  window.addEventListener('scroll', function() {
    var now = Date.now();
    var deltaTime = now - lastScrollTime;
    if (deltaTime === 0) return;

    var deltaY = lastScrollY - window.scrollY;
    scrollVelocity = deltaY / deltaTime;

    // Rapid upward scroll (velocity > 2px/ms) suggests leaving
    if (scrollVelocity > 2 && window.scrollY < 100) {
      showPopup();
    }

    lastScrollY = window.scrollY;
    lastScrollTime = now;
  }, { passive: true });

  // Close popup
  window.closeExitPopup = function() {
    document.getElementById('exit-intent-overlay').style.display = 'none';
  };

  // Close on overlay click (not popup body)
  document.getElementById('exit-intent-overlay').addEventListener('click', function(e) {
    if (e.target === this) {
      closeExitPopup();
    }
  });

  // Form submission ‚Äî tags customer in Shopify for the recovery engine to pick up
  window.handleExitFormSubmit = function(e) {
    e.preventDefault();

    var email = document.getElementById('exit-intent-email').value;
    if (!email) return false;

    // Disable form while submitting
    var submitBtn = document.querySelector('#exit-intent-form button[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';
    }

    // Use Shopify's customer create/update endpoint to register the email
    // This ensures the abandoned cart engine can find and email them
    fetch('/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'form_type=customer&utf8=%E2%9C%93&customer%5Bemail%5D=' + encodeURIComponent(email) +
            '&customer%5Btags%5D=exit-intent-capture%2Ccart-category-' + encodeURIComponent(cartCategory)
    }).catch(function() { /* ignore ‚Äî best effort */ });

    // Also store locally as backup for analytics
    try {
      var stored = JSON.parse(localStorage.getItem('osp_exit_captures') || '[]');
      stored.push({
        email: email,
        cart_total: cartTotal,
        cart_category: cartCategory,
        source: 'exit_intent_popup',
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('osp_exit_captures', JSON.stringify(stored));
    } catch(err) { /* ignore storage errors */ }

    // Show success state
    document.getElementById('exit-intent-form').style.display = 'none';
    document.getElementById('exit-intent-success').style.display = 'block';
    document.getElementById('success-msg').textContent =
      'We\'ll send a cart link to ' + email + ' so you can finish your order anytime.';

    return false;
  };

  // Escape key closes popup
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeExitPopup();
    }
  });
})();
</script>
{% endif %}
