name: Generate Cloud YHS Product Images

on:
  workflow_dispatch:
    inputs:
      start_product:
        description: 'Start from product number (1-102)'
        required: false
        default: '1'
        type: string
      batch_size:
        description: 'Number of products to process'
        required: false
        default: '10'
        type: string
      image_folder:
        description: 'Folder with source images (named by SKU)'
        required: false
        default: 'source_images'
        type: string
      model:
        description: 'Gemini model to use'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini        # Gemini 3 Pro 2K (FLAGSHIP)
          - gemini-4k     # Gemini 3 Pro 4K (Max quality)
          - gemini-flash  # Gemini 2.5 Flash (Fast/budget)

jobs:
  generate-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pandas openpyxl

      - name: Test API Key
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python tools/nano_banana_generator.py --test

      - name: Generate Images for Cloud YHS Products
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "ðŸš€ Generating images for Cloud YHS products"
          echo "   Start: ${{ inputs.start_product }}"
          echo "   Batch: ${{ inputs.batch_size }} products"
          echo "   Model: ${{ inputs.model }}"
          echo "   Source images: ${{ inputs.image_folder }}"
          echo ""
          echo "Image workflow:"
          echo "   1. High-fidelity AI copy â†’ Image #1"
          echo "   2. Original source â†’ Image #2"
          echo ""

          # Run the Cloud YHS importer with image generation enabled
          python tools/cloud_yhs_importer.py \
            --start $(( ${{ inputs.start_product }} - 1 )) \
            --count ${{ inputs.batch_size }} \
            --images "${{ inputs.image_folder }}"

      - name: Upload generated images as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cloud-yhs-images-batch-${{ inputs.start_product }}
          path: generated_images/
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŒ Cloud YHS Image Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Products processed:** ${{ inputs.start_product }} to $(( ${{ inputs.start_product }} + ${{ inputs.batch_size }} - 1 ))" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Workflow" >> $GITHUB_STEP_SUMMARY
          echo "- **Image #1:** High-fidelity AI copy (clean, no watermarks)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image #2:** Original source image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To process more products, run this workflow again with:" >> $GITHUB_STEP_SUMMARY
          echo "- Start product: $(( ${{ inputs.start_product }} + ${{ inputs.batch_size }} ))" >> $GITHUB_STEP_SUMMARY
