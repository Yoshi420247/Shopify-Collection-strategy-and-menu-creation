name: Organize Cloud YHS Products into Collections

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'execute-publish'
        type: choice
        options:
          - analyze        # Just analyze and report
          - execute        # Update tags only
          - execute-publish # Update tags AND publish draft products
  push:
    branches:
      - 'claude/organize-cloud-yhs-*'
    paths:
      - 'src/cloud-yhs-organizer.js'
      - '.github/workflows/organize-cloud-yhs.yml'

jobs:
  organize-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Organize Cloud YHS Products
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "ðŸš€ Organizing Cloud YHS products into collections"
          # Use input action if triggered manually, otherwise default to execute-publish
          ACTION="${{ inputs.action }}"
          if [ -z "$ACTION" ]; then
            ACTION="execute-publish"
          fi
          echo "   Action: $ACTION"
          echo ""

          case "$ACTION" in
            "analyze")
              node src/cloud-yhs-organizer.js
              ;;
            "execute")
              node src/cloud-yhs-organizer.js --execute
              ;;
            "execute-publish")
              node src/cloud-yhs-organizer.js --execute --publish
              ;;
          esac

      - name: Summary
        run: |
          echo "## ðŸ“¦ Cloud YHS Product Organization Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action performed:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Products are organized into collections based on their type:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Product Type | Collection | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Water Pipes | Bongs & Water Pipes | \`family:glass-bong\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Hand Pipes | Hand Pipes | \`family:spoon-pipe\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Bubblers | Bubblers | \`family:bubbler\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Nectar Collectors | Nectar Collectors | \`family:nectar-collector\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dab Tools | Dab Tools | \`family:dab-tool\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Glass Bowls | Flower Bowls | \`family:flower-bowl\` |" >> $GITHUB_STEP_SUMMARY
          echo "| CBD/Vape Devices | Vapes & Electronics | \`family:vape-battery\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Jars/Ashtrays | Storage & Containers | \`family:storage-accessory\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Collection Logic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Products automatically appear in collections based on their \`family:\` tags." >> $GITHUB_STEP_SUMMARY
          echo "Smart collections use rules like \`tag equals family:glass-bong\` to group products." >> $GITHUB_STEP_SUMMARY
