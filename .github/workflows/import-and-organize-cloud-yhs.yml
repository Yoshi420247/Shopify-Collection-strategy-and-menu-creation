name: Import and Organize Cloud YHS Products

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of products to import (leave empty for all)'
        required: false
        default: ''
        type: string
      image_mode:
        description: 'Image mode'
        required: false
        default: 'local'
        type: choice
        options:
          - local      # Use real supplier images (recommended)
          - ai         # Generate AI images with Gemini
          - none       # No images (draft products)
      publish_products:
        description: 'Publish products after organizing'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - 'claude/organize-cloud-yhs-*'
    paths:
      - '.github/workflows/import-and-organize-cloud-yhs.yml'
      - 'tools/cloud_yhs_importer.py'

jobs:
  import-and-organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: pip install requests pandas openpyxl xlrd Pillow

      - name: Install Node.js dependencies
        run: npm install

      - name: Extract product images
        run: |
          if [ -f "product_images.zip" ]; then
            echo "ðŸ“¸ Extracting supplier product images..."
            unzip -o product_images.zip -d product_images/
            echo "âœ“ Extracted $(ls product_images/product_images_described/*.jpeg 2>/dev/null | wc -l) images"
          else
            echo "âš ï¸ No product_images.zip found - will import without images"
          fi

      - name: Import Cloud YHS Products from Excel
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "ðŸ“¦ Importing Cloud YHS products from Excel to Shopify"
          echo ""

          BATCH_ARG=""
          if [ -n "${{ inputs.batch_size }}" ]; then
            BATCH_ARG="--count ${{ inputs.batch_size }}"
          fi

          # Determine image mode
          IMAGE_MODE="${{ inputs.image_mode }}"
          if [ -z "$IMAGE_MODE" ]; then
            IMAGE_MODE="local"
          fi

          case "$IMAGE_MODE" in
            "local")
              echo "ðŸ“¸ Using LOCAL SUPPLIER IMAGES"
              python tools/cloud_yhs_importer.py --local-images $BATCH_ARG
              ;;
            "ai")
              echo "ðŸ¤– Using AI-GENERATED IMAGES (Gemini)"
              python tools/cloud_yhs_importer.py --ai-images $BATCH_ARG
              ;;
            "none")
              echo "ðŸ“ No images - products will be drafts"
              python tools/cloud_yhs_importer.py --no-images $BATCH_ARG
              ;;
          esac

      - name: Organize Products into Collections
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo ""
          echo "ðŸ·ï¸ Organizing products into collections..."
          echo ""

          if [ "${{ inputs.publish_products }}" = "true" ] || [ -z "${{ inputs.publish_products }}" ]; then
            node src/cloud-yhs-organizer.js --execute --publish
          else
            node src/cloud-yhs-organizer.js --execute
          fi

      - name: Summary
        run: |
          echo "## ðŸ“¦ Cloud YHS Import & Organization Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Import Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Mode:** ${{ inputs.image_mode || 'local' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Products Published:** ${{ inputs.publish_products || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Collection Organization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Product Type | Collection | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Water Pipes | Bongs & Water Pipes | ~69 |" >> $GITHUB_STEP_SUMMARY
          echo "| Hand Pipes | Hand Pipes | ~20 |" >> $GITHUB_STEP_SUMMARY
          echo "| Bubblers | Bubblers | ~1 |" >> $GITHUB_STEP_SUMMARY
          echo "| Nectar Collectors | Nectar Collectors | ~2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Dab Tools | Dab Tools | ~2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Glass Bowls | Flower Bowls | ~2 |" >> $GITHUB_STEP_SUMMARY
          echo "| CBD Devices | Vapes & Electronics | ~4 |" >> $GITHUB_STEP_SUMMARY
          echo "| Jars/Ashtrays | Storage & Containers | ~2 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Sources" >> $GITHUB_STEP_SUMMARY
          echo "- **Local:** Real supplier images from product_images.zip (102 images)" >> $GITHUB_STEP_SUMMARY
          echo "- **AI:** Gemini 3 Pro generated images (requires GOOGLE_API_KEY)" >> $GITHUB_STEP_SUMMARY
          echo "- **None:** Products imported as drafts without images" >> $GITHUB_STEP_SUMMARY
