name: Import Cloud YHS Product Listings

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run           # Preview products that will be created
          - execute           # Create products as drafts
          - execute-publish   # Create products and publish to storefront
      start_index:
        description: 'Start from product index (0-based, default: 0)'
        required: false
        default: '0'
        type: string
      batch_size:
        description: 'Number of products to process (default: all)'
        required: false
        default: ''
        type: string
      show_list:
        description: 'List all products only (ignores other options)'
        required: false
        default: false
        type: boolean

jobs:
  import-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install PyMuPDF requests Pillow

      - name: List Products Only
        if: ${{ inputs.show_list == true }}
        run: |
          echo "ðŸ“‹ Listing all products from PDF..."
          python tools/pdf_product_importer.py --list

      - name: Import Products
        if: ${{ inputs.show_list != true }}
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "ðŸš€ Cloud YHS Product Listing Import (PDF)"
          echo "   Action: ${{ inputs.action }}"
          echo "   Start Index: ${{ inputs.start_index }}"
          echo "   Batch Size: ${{ inputs.batch_size || 'all' }}"
          echo ""

          # Build command arguments
          ARGS="--file products.pdf"

          if [ -n "${{ inputs.start_index }}" ] && [ "${{ inputs.start_index }}" != "0" ]; then
            ARGS="$ARGS --start ${{ inputs.start_index }}"
          fi

          if [ -n "${{ inputs.batch_size }}" ]; then
            ARGS="$ARGS --count ${{ inputs.batch_size }}"
          fi

          case "${{ inputs.action }}" in
            "dry-run")
              ARGS="$ARGS --dry-run"
              ;;
            "execute")
              ARGS="$ARGS --execute"
              ;;
            "execute-publish")
              ARGS="$ARGS --execute --publish"
              ;;
          esac

          echo "Running: python tools/pdf_product_importer.py $ARGS"
          echo ""

          python tools/pdf_product_importer.py $ARGS

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Cloud YHS Product Listing Import" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** products.pdf" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Start index:** ${{ inputs.start_index }}" >> $GITHUB_STEP_SUMMARY
          echo "**Batch size:** ${{ inputs.batch_size || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| PDF Parsing | Extracts data and images directly from PDF |" >> $GITHUB_STEP_SUMMARY
          echo "| Creative Titles | Trademark-safe, SEO-optimized naming |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Cost | Stored in Shopify inventory system |" >> $GITHUB_STEP_SUMMARY
          echo "| Retail Price | Automatically set to 2x unit cost |" >> $GITHUB_STEP_SUMMARY
          echo "| Images | Extracted from PDF (correctly oriented) |" >> $GITHUB_STEP_SUMMARY
          echo "| Taxonomy Tags | Proper family/pillar/use tags |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Title Transformations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Original | Creative |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scooby-Doo water pipe | Mystery Hound Water Pipe |" >> $GITHUB_STEP_SUMMARY
          echo "| Lionel Messi water pipe | Soccer Legend Water Pipe |" >> $GITHUB_STEP_SUMMARY
          echo "| Rick water pipe | Mad Scientist Water Pipe |" >> $GITHUB_STEP_SUMMARY
          echo "| Mario hand pipe | Plumber Hero Hand Pipe |" >> $GITHUB_STEP_SUMMARY
