name: Generate Product Images (Nano Banana Pro)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        default: 'preset'
        type: choice
        options:
          - preset    # Use preset (auto-finds competitor images, auto-fills everything)
          - custom    # Custom prompt mode
      preset:
        description: 'Product preset (for preset mode)'
        required: false
        default: 'mylar-bags'
        type: choice
        options:
          - mylar-bags    # Oil Slick Mylar Bags - all variants
          - glass-jars    # Oil Slick Glass Jars
      prompt:
        description: 'Custom prompt (for custom mode only)'
        required: false
        type: string
      model:
        description: 'Model to use'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini        # Nano Banana Pro (Gemini 3 Pro) 2K - FLAGSHIP
          - gemini-4k     # Nano Banana Pro 4K - Maximum resolution
          - gemini-flash  # Gemini 2.5 Flash - Fast/budget
      upload_to_shopify:
        description: 'Upload images to Shopify product'
        required: false
        default: true
        type: boolean
      num_images_per_variant:
        description: 'Images per variant (preset mode) or total images (custom mode)'
        required: false
        default: '1'
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Test API Key
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python tools/nano_banana_generator.py --test

      # PRESET MODE - Fully automated with competitor image search
      - name: Generate Images (Preset Mode)
        if: ${{ inputs.mode == 'preset' }}
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "ðŸš€ Running in PRESET mode: ${{ inputs.preset }}"
          echo "   - Auto-searching for competitor reference images"
          echo "   - Using Nano Banana Pro (Gemini 3 Pro Image)"
          echo ""

          UPLOAD_FLAG=""
          if [ "${{ inputs.upload_to_shopify }}" = "true" ]; then
            UPLOAD_FLAG="--upload"
          fi

          python tools/nano_banana_generator.py \
            --preset ${{ inputs.preset }} \
            --model ${{ inputs.model }} \
            --num-images ${{ inputs.num_images_per_variant }} \
            --output generated_images \
            $UPLOAD_FLAG

      # CUSTOM MODE - Manual prompt with optional competitor search
      - name: Generate Images (Custom Mode)
        if: ${{ inputs.mode == 'custom' }}
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "ðŸŽ¨ Running in CUSTOM mode"
          echo "   Prompt: ${{ inputs.prompt }}"
          echo ""

          mkdir -p generated_images
          for i in $(seq 1 ${{ inputs.num_images_per_variant }}); do
            python tools/nano_banana_generator.py \
              "${{ inputs.prompt }}" \
              --model ${{ inputs.model }} \
              --search-competitors \
              --output "generated_images/custom_image_${i}.png"
            sleep 2
          done

      # Upload custom mode images to Shopify if requested
      - name: Upload Custom Images to Shopify
        if: ${{ inputs.mode == 'custom' && inputs.upload_to_shopify == true }}
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "âš ï¸  Custom mode: Shopify upload requires product_id in preset."
          echo "    Images saved to artifacts instead."

      - name: Upload generated images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-product-images
          path: generated_images/
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŒ Nano Banana Pro - Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.mode }}" = "preset" ]; then
            echo "**Preset:** ${{ inputs.preset }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Prompt:** ${{ inputs.prompt }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Model:** ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "**Upload to Shopify:** ${{ inputs.upload_to_shopify }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la generated_images/ >> $GITHUB_STEP_SUMMARY || echo "No images generated" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reference Images Used" >> $GITHUB_STEP_SUMMARY
          if [ -d "generated_images/references" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -la generated_images/references/ >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No reference images directory found" >> $GITHUB_STEP_SUMMARY
          fi
