name: Deploy Post-Sales Messaging System

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run          # Preview all changes without pushing live
          - execute          # Push theme settings, discount codes, and metafields live

jobs:
  deploy-postsales:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Deploy Post-Sales System
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "=========================================="
          echo "Post-Sales Messaging System Deployment"
          echo "Action: ${{ inputs.action }}"
          echo "=========================================="
          echo ""

          if [ "${{ inputs.action }}" == "execute" ]; then
            echo "LIVE MODE — Pushing changes to Shopify..."
            node src/deploy-postsales.js --execute
          else
            echo "DRY RUN — Preview only, no changes will be made..."
            node src/deploy-postsales.js --dry-run
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## Post-Sales Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Deploys" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Theme Settings | Cart message + chat widget greeting pushed to live theme |" >> $GITHUB_STEP_SUMMARY
          echo "| Discount Codes | WELCOME10, THANKS10, COMEBACK10, MISSYOU10, WELCOME15, VIP15, BDAY20 |" >> $GITHUB_STEP_SUMMARY
          echo "| Metafield Defs | Customer metafields for tracking post-sales message state |" >> $GITHUB_STEP_SUMMARY
          echo "| Flow Guide | Printed setup instructions for 23 Shopify Flow automations |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps After Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Shopify Admin > Apps > Shopify Flow**" >> $GITHUB_STEP_SUMMARY
          echo "2. Create each workflow listed in the deployment output" >> $GITHUB_STEP_SUMMARY
          echo "3. Connect Omnisend email/SMS actions to each flow" >> $GITHUB_STEP_SUMMARY
          echo "4. Copy message templates from \`src/postsales-messages.js\` into Omnisend" >> $GITHUB_STEP_SUMMARY
          echo "5. Test each flow with a test order before enabling for all customers" >> $GITHUB_STEP_SUMMARY
