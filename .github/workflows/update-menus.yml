name: Update Navigation Menus

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run              # Preview menu changes, no modifications
          - execute-all          # Full deploy: create menus + assign to theme
          - execute-menus-only   # Only create/update menu items (no theme changes)
          - execute-theme-only   # Only assign menus to theme header + mega menus
          - validate             # Validate config against live collections

jobs:
  update-menus:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      # ========================================
      # VALIDATE: Check config against live store
      # ========================================
      - name: "Validate menu config against live collections"
        if: ${{ inputs.action == 'validate' }}
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "=========================================="
          echo "  VALIDATING: Menu config vs live store"
          echo "=========================================="
          node src/menu-navigator.js --validate

      # ========================================
      # DRY RUN: Preview all changes
      # ========================================
      - name: "Dry Run: Preview menu structure"
        if: ${{ inputs.action == 'dry-run' }}
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "=========================================="
          echo "  DRY RUN: Preview Navigation Menus"
          echo "=========================================="
          echo ""
          echo "Step 1: Menu items that would be created..."
          echo ""
          node src/auto-menu-setup.js
          echo ""
          echo "=========================================="
          echo "  DRY RUN: Preview Theme Assignment"
          echo "=========================================="
          echo ""
          echo "Step 2: Theme header settings that would change..."
          echo ""
          node src/menu-fixer.js

      # ========================================
      # EXECUTE: Step 1 — Create/update menus via GraphQL
      # ========================================
      - name: "Step 1: Create/update navigation menus"
        if: ${{ inputs.action == 'execute-all' || inputs.action == 'execute-menus-only' }}
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "=========================================="
          echo "  STEP 1: Creating Navigation Menus"
          echo "=========================================="
          echo ""
          echo "Creating/replacing menus via Shopify GraphQL API:"
          echo "  - Main menu (main-menu): 6 sections, 59+ items"
          echo "  - Sidebar menu (sidebar-menu): 5 sections, mobile-optimized"
          echo ""
          node src/auto-menu-setup.js --execute

      # ========================================
      # EXECUTE: Step 2 — Assign menus to theme header + mega menus
      # ========================================
      - name: "Step 2: Assign menus to theme header"
        if: ${{ inputs.action == 'execute-all' || inputs.action == 'execute-theme-only' }}
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          echo "=========================================="
          echo "  STEP 2: Assigning Menus to Theme"
          echo "=========================================="
          echo ""
          echo "Updating theme settings_data.json:"
          echo "  - header.main_linklist → main-menu"
          echo "  - header.main_linklist2 → sidebar-menu"
          echo "  - Mega Menu 1 → Smoke & Vape"
          echo "  - Mega Menu 2 → Accessories"
          echo ""
          node src/menu-fixer.js --execute

      # ========================================
      # SUMMARY
      # ========================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## Navigation Menu Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.action }}" == "dry-run" ]; then
            echo "**This was a dry run.** No changes were made to Shopify." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run again with \`execute-all\` to apply all changes." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.action }}" == "validate" ]; then
            echo "**Validation complete.** Check logs for any missing collections." >> $GITHUB_STEP_SUMMARY
          else
            echo "### What was done" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Step | Action | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY

            if [ "${{ inputs.action }}" == "execute-all" ]; then
              echo "| 1 | Create/update navigation menus (main + sidebar) | Executed |" >> $GITHUB_STEP_SUMMARY
              echo "| 2 | Assign menus to theme header + configure mega menus | Executed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ inputs.action }}" == "execute-menus-only" ]; then
              echo "| 1 | Create/update navigation menus (main + sidebar) | Executed |" >> $GITHUB_STEP_SUMMARY
              echo "| 2 | Assign menus to theme header | Skipped |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ inputs.action }}" == "execute-theme-only" ]; then
              echo "| 1 | Create/update navigation menus | Skipped |" >> $GITHUB_STEP_SUMMARY
              echo "| 2 | Assign menus to theme header + configure mega menus | Executed |" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Menu Structure" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Section | Sub-items |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Shop All | — |" >> $GITHUB_STEP_SUMMARY
            echo "| Smoke & Vape | 11 |" >> $GITHUB_STEP_SUMMARY
            echo "| Accessories | 16 |" >> $GITHUB_STEP_SUMMARY
            echo "| Extraction & Packaging | 9 |" >> $GITHUB_STEP_SUMMARY
            echo "| Brands | 15 |" >> $GITHUB_STEP_SUMMARY
            echo "| Featured | 8 |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Shopify Admin - Navigation](https://oil-slick-pad.myshopify.com/admin/menus)" >> $GITHUB_STEP_SUMMARY
          echo "- [Shopify Admin - Theme Customizer](https://oil-slick-pad.myshopify.com/admin/themes/current/editor)" >> $GITHUB_STEP_SUMMARY
          echo "- [Live Site](https://oilslickpad.com)" >> $GITHUB_STEP_SUMMARY
